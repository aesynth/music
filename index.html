<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Warmer/Colder Radio</title>
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
<script src="https://unpkg.com/tonal@4.14.2/build/tonal.min.js"></script>
<style>
  body{font-family:system-ui;background:#0b0f14;color:#e6f1ff;display:grid;place-items:center;height:100vh;margin:0}
  .panel{background:#0f1621;border:1px solid #1e2a3a;padding:16px 20px;border-radius:14px;box-shadow:0 6px 30px #0008}
  h1{margin:0 0 8px;font-size:18px}
  button{margin:6px 4px;padding:10px 14px;border-radius:10px;border:1px solid #2c3e55;background:#152132;color:#e6f1ff;cursor:pointer}
  button:hover{background:#1b2a41}
  .meta{opacity:.8;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<div class="panel">
  <h1>Never-Ending “Warmer/Colder” Radio</h1>
  <div>
    <button id="start">Start</button>
    <button id="warmer">Warmer</button>
    <button id="colder">Colder</button>
  </div>
  <div class="meta" id="meta"></div>
</div>

<script>
const { Scale, Note } = Tonal;

// --- Feature vector θ (what the listener seems to like)
let theta = JSON.parse(localStorage.getItem("theta_v1")||"null") || {
  tempo: 96,           // bpm
  density: 0.55,       // notes per beat (0-1)
  syncopation: 0.35,   // offbeat emphasis (0-1)
  brightness: 0.45,    // higher notes / open voicings (0-1)
  dissonance: 0.25,    // tension (0-1)
  swing: 0.15,         // 0-0.5
};

const key = { tonic: "D", mode: "dorian" }; // nice for many genres
const scale = Scale.get(`${key.tonic} ${key.mode}`).notes; // e.g., D dorian
let bar = 0;

// --- Instruments
const reverb = new Tone.Reverb({ decay: 3, wet: 0.2 }).toDestination();
const comp = new Tone.Compressor().connect(reverb);

const bass = new Tone.MonoSynth({
  oscillator: { type: "triangle" },
  filter: { Q: 1, type: "lowpass", rolloff: -24 },
  envelope: { attack: 0.01, sustain: 0.4, release: 0.3 }
}).connect(comp);

const pluck = new Tone.PolySynth(Tone.Synth, {
  oscillator: { type: "sine" },
  envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.6 }
}).connect(comp);

const hat = new Tone.MetalSynth({ resonance: 200, harmonicity: 5, envelope: { attack: 0.001, decay: 0.12, release: 0.05 }}).connect(comp);

// --- Simple chord grammar (dorian-ish)
const chordPool = ["Dm7","Em7b5","Fmaj7","G7","Am7","Cmaj7","Bbmaj7"]; // modal color
const chordTransitions = {
  "Dm7": ["G7","Fmaj7","Cmaj7","Am7"],
  "G7": ["Cmaj7","Dm7","Bbmaj7","Fmaj7"],
  "Fmaj7": ["G7","Dm7","Cmaj7","Am7"],
  "Cmaj7": ["Dm7","Fmaj7","Bbmaj7","Am7"],
  "Am7": ["Dm7","Fmaj7","G7"],
  "Bbmaj7": ["Cmaj7","Dm7","G7"],
  "Em7b5": ["Am7","Dm7","G7"]
};
let currentChord = "Dm7";

function choose(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function nextChord() {
  const opts = chordTransitions[currentChord] || chordPool;
  // small preference toward functional motion
  return Math.random()<0.7 ? choose(opts) : choose(chordPool);
}

function chordToNotes(sym, bright=0.4){
  // very small, genre-agnostic voicing helper
  const rootName = sym.match(/[A-G][b#]?/)[0];
  const quality = sym.replace(rootName,"");
  const rootMidi = Note.midi(rootName+"3"); // mid register base
  let intervals = [0, 7, 10]; // default 7th triad-ish
  if (quality.includes("maj7")) intervals = [0, 4, 7, 11];
  else if (quality.includes("m7b5")) intervals = [0, 3, 6, 10];
  else if (quality.includes("m7")) intervals = [0, 3, 7, 10];
  else if (quality.includes("7")) intervals = [0, 4, 7, 10];
  // brightness opens voicing upward
  const lift = Math.round(bright*2);
  return intervals.map(iv => Note.fromMidi(rootMidi + iv + (lift?12:0)));
}

// --- Rhythm helpers
function euclidean(k, n){ // returns array of n with k ones distributed
  const pattern = Array(n).fill(0);
  for (let i=0;i<k;i++){ pattern[Math.floor(i*n/k)] = 1; }
  return pattern;
}

function scheduleBar(time){
  // Update meta display
  document.getElementById("meta").textContent =
    `Bar ${bar} • ${currentChord} • tempo ${Math.round(theta.tempo)} • density ${theta.density.toFixed(2)} • sync ${theta.syncopation.toFixed(2)}`;

  // Pick next chord occasionally
  if (bar % 2 === 0) currentChord = nextChord();
  const chordNotes = chordToNotes(currentChord, theta.brightness);

  // Bass on beats 1 & 3 (with variation)
  const bassNote = chordNotes[0].replace(/\d+$/,"2");
  [0, 1.5 + (theta.syncopation>0.4?0.25:0)].forEach(beat => {
    bass.triggerAttackRelease(bassNote, "8n", time + beat);
  });

  // Pluck chords: density controls hits per bar
  const hits = Math.max(1, Math.round(4 * theta.density));
  for (let i=0;i<hits;i++){
    const pos = (i*(4/hits)) + (Math.random()<theta.syncopation?0.5:0);
    pluck.triggerAttackRelease(chordNotes, "8n", time + pos*0.5); // 0.5 = 8n in 4/4 at scheduler grid
  }

  // Hats via Euclidean pattern
  const hatSteps = 8;
  const hatHits = Math.max(2, Math.round(hatSteps*(0.4+theta.density*0.4)));
  const hatPat = euclidean(hatHits, hatSteps);
  for (let s=0;s<hatSteps;s++){
    if (hatPat[s]) hat.triggerAttackRelease("16n", time + s*0.25);
  }

  bar++;
}

let loop;

async function start(){
  await Tone.start();
  Tone.Transport.bpm.value = theta.tempo;
  Tone.Transport.swing = theta.swing;
  loop = new Tone.Loop((t)=>scheduleBar(t), "2m"); // schedule per 2 measures
  loop.start(0);
  Tone.Transport.start();
}

function nudge(dir){ // dir = +1 warmer, -1 colder
  // Simple contextual bandit-ish update (online gradient-free nudge)
  const lr = 0.05*dir;
  theta.density = clamp(theta.density + lr*(Math.random()*0.6+0.2), 0.1, 0.95);
  theta.syncopation = clamp(theta.syncopation + lr*(Math.random()*0.6+0.2), 0.0, 0.9);
  theta.brightness = clamp(theta.brightness + lr*(Math.random()*0.6+0.2), 0.1, 0.95);
  theta.dissonance = clamp(theta.dissonance + lr*(Math.random()*0.5), 0.0, 0.8);
  theta.swing = clamp(theta.swing + lr*0.05, 0.0, 0.4);
  // small tempo drift to your taste
  theta.tempo = clamp(theta.tempo + lr*8, 70, 130);
  Tone.Transport.bpm.rampTo(theta.tempo, 0.5);
  Tone.Transport.swing = theta.swing;
  localStorage.setItem("theta_v1", JSON.stringify(theta));
}

function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }

document.getElementById("start").onclick = start;
document.getElementById("warmer").onclick = ()=>nudge(+1);
document.getElementById("colder").onclick = ()=>nudge(-1);
</script>
</body>
</html>
